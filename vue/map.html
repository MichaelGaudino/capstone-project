<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autocomplete Places Search Box using Google Maps Javascript API</title>
        <h1 id="map-title">Use our interactive map to find a course near you!</h1>

    <!-- Bootstrap Library ***********************--> 
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">

    <!-- jQuery & jQueryUI Library ***********************************************************-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <!-- Google Maps JavaScript API ***************************************************************-->
      <script defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyChXcD4Ca6q3TZGs0A7NasDBKCLwM9q3lY&callback=initMap">
      </script>

    <!-- CSS *****************************************************************************************-->
    <link rel="stylesheet" href="style.css">

    <!-- JavaScript File -->
    <link rel="stylesheet" href="maps.js">
    </head>


    <body>

        <div class="container">

<!-- This section is used to change the location when the marker position is changed by drag and drop **-->
    <script>
        let geocoder;
        let map;
        let marker;
    
    /*
     * Google Map with marker *****************************************************************************
     */
    function initialize() {
        let initialLat = $('.search_latitude').val();
        let initialLong = $('.search_longitude').val();
        initialLat = initialLat?initialLat:36.169648;
        initialLong = initialLong?initialLong:-115.141000;
    
        let latlng = new google.maps.LatLng(initialLat, initialLong);
        let options = {
            zoom: 16,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
    
        map = new google.maps.Map(document.getElementById("geomap"), options);
    
        geocoder = new google.maps.Geocoder();
    
        marker = new google.maps.Marker({
            map: map,
            draggable: true,
            position: latlng
        });
    
        google.maps.event.addListener(marker, "dragend", function () {
            let point = marker.getPosition();
            map.panTo(point);
            geocoder.geocode({'latLng': marker.getPosition()}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    map.setCenter(results[0].geometry.location);
                    marker.setPosition(results[0].geometry.location);
                    $('.search_addr').val(results[0].formatted_address);
                    $('.search_latitude').val(marker.getPosition().lat());
                    $('.search_longitude').val(marker.getPosition().lng());
                }
            });
        });
    
    }
    
    $(document).ready(function () {
        //load the google map **************************************************************
        initialize();
        
        /*
         * autocomplete location search **************************************************************
         */
        let PostCodeid = '#search_location';
        $(function () {
            $(PostCodeid).autocomplete({
                source: function (request, response) {
                    geocoder.geocode({
                        'address': request.term
                    }, function (results, status) {
                        response($.map(results, function (item) {
                            return {
                                label: item.formatted_address,
                                value: item.formatted_address,
                                lat: item.geometry.location.lat(),
                                lon: item.geometry.location.lng()
                            };
                        }));
                    });
                },
                select: function (event, ui) {
                    $('.search_addr').val(ui.item.value);
                    $('.search_latitude').val(ui.item.lat);
                    $('.search_longitude').val(ui.item.lon);
                    let latlng = new google.maps.LatLng(ui.item.lat, ui.item.lon);
                    marker.setPosition(latlng);
                    initialize();
                }
            });
        });
        
        /*
         * Point location on google map *******************************************************************
         */
        $('.get_map').click(function (e) {
            let address = $(PostCodeid).val();
            geocoder.geocode({'address': address}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    map.setCenter(results[0].geometry.location);
                    marker.setPosition(results[0].geometry.location);
                    $('.search_addr').val(results[0].formatted_address);
                    $('.search_latitude').val(marker.getPosition().lat());
                    $('.search_longitude').val(marker.getPosition().lng());
                } else {
                    alert("Geocode was not successful for the following reason: " + status);
                }
            });
            e.preventDefault();
        });
    
        //Add listener to marker for reverse geocoding ***********************************************************
        google.maps.event.addListener(marker, 'drag', function () {
            geocoder.geocode({'latLng': marker.getPosition()}, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[0]) {
                        $('.search_addr').val(results[0].formatted_address);
                        $('.search_latitude').val(marker.getPosition().lat());
                        $('.search_longitude').val(marker.getPosition().lng());
                    }
                }
            });
        });
    });
    </script>

    
    <!-- search input box *************************************************************************-->
    <form>
    <div class="form-group input-group">
        <input type="text" id="search_location" class="form-control" placeholder="Search location">
        <div class="input-group-btn">
            <button class="btn btn-default get_map" type="submit">
                Locate
            </button>
        </div>
    </div>
    </form>
    
    <!-- display google map ***********************************************************************-->
    <div id="geomap"></div>
    <!-- display selected location information ****************************************************-->
    <h4>Location Details</h4>
    <p>Address: <input type="text" class="search_addr" size="45"></p>
    <p>Latitude: <input type="text" class="search_latitude" size="30"></p>
    <p>Longitude: <input type="text" class="search_longitude" size="30"></p>
    </div>
</body>
</html>